generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                 String                   @id @default(cuid()) @map("product_id")
  sku                String?                  @unique
  barcode            String?
  name               String
  englishName        String?                  @map("english_name")
  description        String?
  brand              String?
  categoryId         String                   @map("category_id")
  price              Float
  costPrice          Float                    @default(0) @map("cost_price")
  discountedPrice    Float?                   @map("discounted_price")
  wholesale          Float?                   @map("wholesale")
  taxInclusivePrice  Float?                   @map("tax_inclusive_price")
  taxRate            Float?                   @map("tax_rate")
  unitSize           String?                  @map("unit_size")
  unitType           String?                  @map("unit_type")
  unit               String?                  @map("unit")
  stockLevel         Float                    @default(0) @map("stock_level")
  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")
  inventory          Inventory[]
  images             ProductImage[]
  productTags        ProductTagMap[]
  category           Category                 @relation(fields: [categoryId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  inventoryReports   ReportInventorySummary[]
  salesDetails       SalesDetail[]
  stockTransactions  StockTransaction[]

  @@map("products")
}

model Category {
  id               String     @id @default(cuid()) @map("category_id")
  name             String
  parentCategoryId String?    @map("parent_category_id")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  parentCategory   Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  subCategories    Category[] @relation("CategoryHierarchy")
  products         Product[]

  @@map("categories")
}

model ProductImage {
  id        String   @id @default(cuid()) @map("image_id")
  productId String   @map("product_id")
  url       String
  altText   String?  @map("alt_text")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductTag {
  id          String          @id @default(cuid()) @map("tag_id")
  name        String          @unique
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  productTags ProductTagMap[]

  @@map("product_tags")
}

model ProductTagMap {
  productId String     @map("product_id")
  tagId     String     @map("tag_id")
  createdAt DateTime   @default(now()) @map("created_at")
  tag       ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  product   Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tag_map")
}

model Employee {
  id                   String                @id @default(cuid())
  employee_id          String                @unique
  name                 String
  role                 String                // Keep legacy role field for backwards compatibility
  email                String                @unique
  address              String?
  password_hash        String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  employeeSalesReports ReportEmployeeSales[]
  salesInvoices        SalesInvoice[]
  payments             Payment[]
  shiftLogs            ShiftLog[]
  employeeRoles        EmployeeRole[]        // New role-based permissions

  @@map("employee")
}

model Inventory {
  id           String    @id @default(cuid()) @map("inventory_id")
  productId    String    @unique @map("product_id")
  quantity     Float
  reorderLevel Int       @map("reorder_level")
  batchNumber  String?   @map("batch_number")
  expiryDate   DateTime? @map("expiry_date")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  product      Product   @relation(fields: [productId], references: [id])

  @@map("inventory")
}

model StockTransaction {
  id               String   @id @default(cuid()) @map("transaction_id")
  productId        String   @map("product_id")
  type             String   @default("OUT") // "IN" for incoming stock, "OUT" for outgoing stock
  changeQty        Float    @map("change_qty")
  reason           String
  transactionDate  DateTime @default(now()) @map("transaction_date")
  relatedInvoiceId String?  @map("related_invoice_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  product          Product  @relation(fields: [productId], references: [id])

  @@map("stock_transactions")
}

model Supplier {
  id             String          @id @default(cuid()) @map("supplier_id")
  name           String
  contactName    String?         @map("contact_name")
  phone          String?
  email          String?
  address        String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model PurchaseOrder {
  id          String              @id @default(cuid()) @map("po_id")
  supplierId  String              @map("supplier_id")
  orderDate   DateTime            @map("order_date")
  status      String
  totalAmount Float               @map("total_amount")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  items       PurchaseOrderItem[]
  supplier    Supplier            @relation(fields: [supplierId], references: [id])

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id            String        @id @default(cuid()) @map("po_item_id")
  poId          String        @map("po_id")
  productId     String        @map("product_id")
  quantity      Float
  unitPrice     Float         @map("unit_price")
  receivedDate  DateTime?     @map("received_date")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  product       Product       @relation(fields: [productId], references: [id])
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])

  @@map("purchase_order_items")
}

model Customer {
  id                   String                   @id @default(cuid()) @map("customer_id")
  name                 String
  email                String?
  phone                String?
  address              String?
  loyaltyPoints        Int                      @default(0) @map("loyalty_points")
  preferences          String?
  createdAt            DateTime                 @default(now()) @map("created_at")
  updatedAt            DateTime                 @updatedAt @map("updated_at")
  customerTransactions CustomerTransaction[]
  customerReports      ReportCustomerInsights[]
  salesInvoices        SalesInvoice[]

  @@map("customers")
}

model SalesInvoice {
  id                   String                @id @default(cuid()) @map("invoice_id")
  date                 DateTime              @default(now())
  customerId           String?               @map("customer_id")
  employeeId           String                @map("employee_id")
  subTotal             Float                 @map("sub_total")
  totalAmount          Float                 @map("total_amount")
  paymentMode          String                @map("payment_mode")
  taxAmount            Float                 @default(0) @map("tax_amount")
  discountAmount       Float                 @default(0) @map("discount_amount")
  amountReceived       Float                 @map("amount_received")
  outstandingBalance   Float                 @default(0) @map("outstanding_balance")
  paymentStatus        String                @default("paid") @map("payment_status") // "paid", "partial", "unpaid"
  refundInvoiceId      String?               @map("refund_invoice_id")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  customerTransactions CustomerTransaction[]
  salesDetails         SalesDetail[]
  payments             Payment[]
  employee             Employee              @relation(fields: [employeeId], references: [id])
  customer             Customer?             @relation(fields: [customerId], references: [id])

  @@map("sales_invoices")
}

model Payment {
  id          String       @id @default(cuid()) @map("payment_id")
  invoiceId   String       @map("invoice_id")
  amount      Float        @map("amount")
  paymentMode String       @map("payment_mode") // "cash", "card", "credit", etc.
  employeeId  String       @map("employee_id")
  notes       String?      @map("notes")
  createdAt   DateTime     @default(now()) @map("created_at")
  invoice     SalesInvoice @relation(fields: [invoiceId], references: [id])
  employee    Employee     @relation(fields: [employeeId], references: [id])

  @@map("payments")
}

model CustomProduct {
  id           String        @id @default(cuid()) @map("custom_product_id")
  name         String
  price        Float
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  salesDetails SalesDetail[]

  @@map("custom_products")
}

model SalesDetail {
  id              String         @id @default(cuid()) @map("sales_detail_id")
  invoiceId       String         @map("invoice_id")
  productId       String?        @map("product_id")
  customProductId String?        @map("custom_product_id")
  unit            String         @default("pcs")
  originalPrice   Float          @default(0)
  costPrice       Float          @default(0) @map("cost_price")
  quantity        Float
  unitPrice       Float          @map("unit_price")
  taxRate         Float          @default(0) @map("tax_rate")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  product         Product?       @relation(fields: [productId], references: [id])
  customProduct   CustomProduct? @relation(fields: [customProductId], references: [id])
  invoice         SalesInvoice   @relation(fields: [invoiceId], references: [id])

  @@map("sales_details")
}

model ShiftLog {
  id         String    @id @default(cuid()) @map("log_id")
  employeeId String    @map("employee_id")
  shiftStart DateTime  @map("shift_start")
  shiftEnd   DateTime? @map("shift_end")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  employee   Employee  @relation(fields: [employeeId], references: [id])

  @@map("shift_logs")
}

model CustomerTransaction {
  customerId     String       @map("customer_id")
  invoiceId      String       @map("invoice_id")
  pointsEarned   Int          @default(0) @map("points_earned")
  pointsRedeemed Int          @default(0) @map("points_redeemed")
  createdAt      DateTime     @default(now()) @map("created_at")
  invoice        SalesInvoice @relation(fields: [invoiceId], references: [id])
  customer       Customer     @relation(fields: [customerId], references: [id])

  @@id([customerId, invoiceId])
  @@map("customer_transactions")
}

model ReportDailySalesSummary {
  id                String   @id @default(cuid()) @map("report_id")
  reportDate        DateTime @map("report_date")
  totalSales        Float    @map("total_sales")
  totalTransactions Int      @map("total_transactions")
  totalTax          Float    @map("total_tax")
  totalDiscount     Float    @map("total_discount")
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("report_daily_sales_summary")
}

model ReportInventorySummary {
  id         String   @id @default(cuid()) @map("report_id")
  reportDate DateTime @map("report_date")
  productId  String   @map("product_id")
  quantity   Float
  createdAt  DateTime @default(now()) @map("created_at")
  product    Product  @relation(fields: [productId], references: [id])

  @@map("report_inventory_summary")
}

model ReportEmployeeSales {
  id                String   @id @default(cuid()) @map("report_id")
  reportDate        DateTime @map("report_date")
  employeeId        String   @map("employee_id")
  totalSales        Float    @map("total_sales")
  totalTransactions Int      @map("total_transactions")
  createdAt         DateTime @default(now()) @map("created_at")
  employee          Employee @relation(fields: [employeeId], references: [id])

  @@map("report_employee_sales")
}

model ReportCustomerInsights {
  id                String   @id @default(cuid()) @map("report_id")
  reportDate        DateTime @map("report_date")
  customerId        String   @map("customer_id")
  totalSpent        Float    @map("total_spent")
  transactionsCount Int      @map("transactions_count")
  pointsEarned      Int      @map("points_earned")
  pointsRedeemed    Int      @map("points_redeemed")
  createdAt         DateTime @default(now()) @map("created_at")
  customer          Customer @relation(fields: [customerId], references: [id])

  @@map("report_customer_insights")
}

model Settings {
  id          String   @id @default(cuid()) @map("setting_id")
  key         String   @unique
  value       String
  type        String   @default("string") // "string", "number", "boolean", "json"
  category    String   @default("general") // "general", "system", "security", "notifications"
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Role {
  id               String            @id @default(cuid()) @map("role_id")
  name             String            @unique
  description      String?
  isSystem         Boolean           @default(false) @map("is_system") // System roles cannot be deleted
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  rolePermissions  RolePermission[]
  employeeRoles    EmployeeRole[]

  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid()) @map("permission_id")
  module          String           // e.g., "invoices", "products", "customers", "reports"
  action          String           // e.g., "view", "create", "edit", "delete", "refund"
  scope           String?          // e.g., "daily", "monthly", "all", "own", "department"
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]

  @@unique([module, action, scope])
  @@map("permissions")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now()) @map("created_at")
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model EmployeeRole {
  employeeId String   @map("employee_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String?  @map("assigned_by") // Employee ID of who assigned the role
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([employeeId, roleId])
  @@map("employee_roles")
}
